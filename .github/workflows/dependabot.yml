name: Dependabot

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9 AM UTC
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  dependabot:
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]' || github.event_name == 'schedule'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Update Maven dependencies
        if: github.event_name == 'schedule'
        run: |
          cd backend
          mvn versions:use-latest-versions -DgenerateBackupPoms=false -DallowSnapshots=false
          mvn versions:update-parent -DgenerateBackupPoms=false
          mvn versions:update-properties -DgenerateBackupPoms=false

      - name: Update npm dependencies
        if: github.event_name == 'schedule'
        run: |
          cd frontend
          npm update
          npm audit fix

      - name: Update Docker base images
        if: github.event_name == 'schedule'
        run: |
          # Update Docker images in docker-compose files
          find . -name "*.yml" -o -name "*.yaml" | xargs grep -l "FROM" | while read -r file; do
            # This would typically use a tool like docker-update or manual updates
            echo "Checking $file for outdated base images"
          done

      - name: Run tests after updates
        run: |
          cd backend
          mvn test -Dtest.failure.ignore=true
          cd ../frontend
          npm test -- --watchAll=false

      - name: Create Pull Request
        if: github.event_name == 'schedule'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update dependencies

            - Updated Maven dependencies to latest versions
            - Updated npm dependencies
            - Updated Docker base images where applicable
          title: 'chore: update dependencies'
          body: |
            This PR updates project dependencies to their latest versions.

            ## Changes
            - Maven dependencies updated to latest stable versions
            - npm packages updated
            - Docker base images reviewed for updates

            ## Testing
            - Backend tests: ✅
            - Frontend tests: ✅

            Please review the changes and ensure compatibility before merging.
          branch: dependabot/dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated
          reviewers: |
            @Dieg0bl
